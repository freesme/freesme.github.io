---
layout: post
title: NAT Traversal(libp2p)
date: 2024-10-17 12:19 +0800
categories: [ network ]
tag: [ p2p ]
comments: true
---

# NATS
## æ¦‚è§ˆ

å› ç‰¹ç½‘ç”±æ— æ•°çš„ç½‘ç»œç»„æˆï¼Œè¿™äº›ç½‘ç»œé€šè¿‡åŸºç¡€ä¼ è¾“åè®®ç»‘å®šåˆ°å…±äº«çš„åœ°å€ç©ºé—´ä¸­ã€‚

å½“æµé‡åœ¨ç½‘ç»œè¾¹ç•Œä¹‹é—´ç§»åŠ¨æ—¶ï¼Œé€šå¸¸ä¼šå‘ç”Ÿç§°ä¸ºç½‘ç»œåœ°å€è½¬æ¢çš„è¿‡ç¨‹ã€‚NAT ï¼ˆNetwork Address Translationï¼‰æ˜¯ä¸€ç§å°†åœ°
å€ä»ä¸€ä¸ªåœ°å€ç©ºé—´æ˜ å°„åˆ°å¦ä¸€ä¸ªåœ°å€ç©ºé—´çš„æŠ€æœ¯ã€‚

NATå…è®¸è®¸å¤šæœºå™¨å…±äº«ä¸€ä¸ªå…¬å…±åœ°å€ï¼Œå®ƒå¯¹äºIPv4åè®®çš„æŒç»­è¿ä½œè‡³å…³é‡è¦ï¼Œå¦åˆ™å®ƒå°†æ— æ³•æ»¡è¶³ç°ä»£ç½‘ç»œäººå£çš„32ä½åœ°å€ç©ºé—´çš„éœ€æ±‚ã€‚

ä¾‹å¦‚ï¼Œå½“æˆ‘è¿æ¥åˆ°å®¶é‡Œçš„wifiæ—¶ï¼Œæˆ‘çš„ç”µè„‘å¾—åˆ°ä¸€ä¸ªIPv4åœ°å€`10.0.1.15`ã€‚è¿™æ˜¯ä¿ç•™ç»™ç§æœ‰ç½‘ç»œå†…éƒ¨ä½¿ç”¨çš„IPåœ°å€èŒƒå›´çš„ä¸€éƒ¨åˆ†ã€‚å½“æˆ‘å‘ä¸€ä¸ªå…¬å…±IPåœ°å€å‘å‡ºè¿æ¥æ—¶ï¼Œè·¯ç”±å™¨ç”¨å®ƒè‡ªå·±çš„å…¬å…±IPåœ°å€æ›¿æ¢æˆ‘çš„å†…éƒ¨IPåœ°å€ã€‚å½“æ•°æ®ä»å¦ä¸€ç«¯è¿”å›æ—¶ï¼Œè·¯ç”±å™¨å°†è½¬æ¢å›å†…éƒ¨åœ°å€ã€‚

è™½ç„¶NATå¯¹äºä¼ å‡ºè¿æ¥é€šå¸¸æ˜¯é€æ˜çš„ï¼Œä½†æ˜¯ä¾¦å¬ä¼ å…¥è¿æ¥éœ€è¦ä¸€äº›é…ç½®ã€‚è·¯ç”±å™¨ç›‘å¬å•ä¸ªå…¬å…±IPåœ°å€ï¼Œä½†æ˜¯å†…éƒ¨ç½‘ç»œä¸Šçš„ä»»ä½•æ•°é‡çš„æœºå™¨éƒ½å¯ä»¥å¤„ç†è¯·æ±‚ã€‚ä¸ºäº†æœåŠ¡è¯·æ±‚ï¼Œä½ çš„è·¯ç”±å™¨å¿…é¡»é…ç½®ä¸ºå‘é€ç‰¹å®šçš„æµé‡åˆ°ç‰¹å®šçš„æœºå™¨ï¼Œé€šå¸¸æ˜¯é€šè¿‡å°†ä¸€ä¸ªæˆ–å¤šä¸ªTCPæˆ–UDPç«¯å£ä»å…¬å…±IPæ˜ å°„åˆ°å†…éƒ¨IPã€‚

è™½ç„¶é€šå¸¸å¯ä»¥æ‰‹åŠ¨é…ç½®è·¯ç”±å™¨ï¼Œä½†å¹¶ä¸æ˜¯æ¯ä¸ªæƒ³è¦è¿è¡Œç‚¹å¯¹ç‚¹åº”ç”¨ç¨‹åºæˆ–å…¶ä»–ç½‘ç»œæœåŠ¡çš„äººéƒ½æœ‰èƒ½åŠ›è¿™æ ·åšã€‚
æˆ‘ä»¬å¸Œæœ›libp2påº”ç”¨ç¨‹åºå¯ä»¥åœ¨ä»»ä½•åœ°æ–¹è¿è¡Œï¼Œè€Œä¸ä»…ä»…æ˜¯åœ¨æ•°æ®ä¸­å¿ƒæˆ–å…·æœ‰ç¨³å®šå…¬å…±IPåœ°å€çš„æœºå™¨ä¸Šã€‚ä¸ºäº†å®ç°è¿™ä¸€ç‚¹ï¼Œä¸‹é¢æ˜¯ç›®å‰libp2pä¸­å¯ç”¨çš„NATéå†çš„ä¸»è¦æ–¹æ³•ã€‚

## è‡ªåŠ¨è·¯ç”±å™¨é…ç½®

è®¸å¤šè·¯ç”±å™¨æ”¯æŒç«¯å£è½¬å‘çš„è‡ªåŠ¨é…ç½®åè®®ï¼Œæœ€å¸¸è§çš„æ˜¯[UPnP](https://en.wikipedia.org/wiki/Universal_Plug_and_Play)æˆ–[nat-pmp](https://en.wikipedia.org/wiki/NAT_Port_Mapping_Protocol)ã€‚

å¦‚æœæ‚¨çš„è·¯ç”±å™¨æ”¯æŒå…¶ä¸­ä¸€ç§åè®®ï¼Œlibp2på°†å°è¯•è‡ªåŠ¨é…ç½®ä¸€ä¸ªç«¯å£æ˜ å°„ï¼Œä»¥å…è®¸å®ƒä¾¦å¬ä¼ å…¥çš„é€šä¿¡ã€‚å¦‚æœç½‘ç»œå’Œlibp2på®ç°æ”¯æŒï¼Œè¿™é€šå¸¸æ˜¯æœ€ç®€å•çš„é€‰é¡¹ã€‚

#  AutoNAT
## èƒŒæ™¯

è™½ç„¶è¯†åˆ«åè®®å…è®¸å¯¹ç­‰èŠ‚ç‚¹ç›¸äº’é€šçŸ¥å®ƒä»¬è§‚å¯Ÿåˆ°çš„ç½‘ç»œåœ°å€ï¼Œä½†æœ‰æ—¶è¿™äº›åœ°å€æ˜¯ä¸å¯è®¿é—®çš„ï¼Œå› ä¸ºå¯¹ç­‰èŠ‚ç‚¹å¯èƒ½ä½äºç§æœ‰ç½‘ç»œä¸­ï¼ˆå³ï¼Œåœ¨NATæˆ–é˜²ç«å¢™åé¢ï¼‰ã€‚

> ä¸å¯åˆ°è¾¾çš„å¹¿å‘Šåœ°å€å¯¹P2Pç½‘ç»œçš„å¥åº·æ˜¯æœ‰å®³çš„ï¼Œå› ä¸ºå…¶ä»–èŠ‚ç‚¹å°†æ— æ³•æˆåŠŸåœ°å°è¯•æ‹¨æ‰“è¿™äº›åœ°å€ï¼Œä»è€Œæµªè´¹è®¡ç®—å’Œç½‘ç»œèµ„æºã€‚

ä¸ºäº†é˜²æ­¢å¹¿å‘Šå’Œæ‹¨å·ä¸å¯è¾¾åœ°å€çš„é—®é¢˜ï¼Œlibp2på®ç°äº†ä¸€ç§ç§°ä¸ºAutoNATçš„åè®®ï¼Œè¯¥åè®®å…è®¸èŠ‚ç‚¹ç¡®å®šå®ƒä»¬æ˜¯å¦åœ¨NATåé¢ã€‚

## ä»€ä¹ˆæ˜¯AutoNAT?

AutoNATå…è®¸èŠ‚ç‚¹è¯·æ±‚å…¶ä»–èŠ‚ç‚¹æ‹¨æ‰“å…¶å‡å®šçš„å…¬å…±åœ°å€ã€‚

å¯¹äºä½äºNATåé¢çš„ç§æœ‰èŠ‚ç‚¹ï¼Œå¼ºçƒˆå»ºè®®ï¼š

- ä¸é€šå‘Šç§æœ‰åœ°å€
- ä½¿ç”¨ä¸­ç»§è¿›è¡Œé¢„è®¢ï¼Œä»¥æ”¹å–„åˆ°å…¬å…±ç½‘ç»œçš„è¿æ¥æ€§ï¼Œè€Œä¸æ˜¯å‘å¸ƒä¸­ç»§åœ°å€

å¯¹äºå…¬æœ‰èŠ‚ç‚¹ï¼Œå»ºè®®ï¼š

- å¯åŠ¨ä¸­ç»§ä»¥ååŠ©å…¶ä»–èŠ‚ç‚¹
- è€ƒè™‘æ¿€æ´»DHTæœåŠ¡å™¨æ¨¡å¼ä»¥æ”¹å–„åˆ°å…¬å…±ç½‘ç»œçš„è¿æ¥æ€§
- å¦‚æœå¤§å¤šæ•°æ‹¨å·å°è¯•éƒ½æˆåŠŸï¼Œåˆ™èŠ‚ç‚¹å¯ä»¥åˆç†åœ°ç¡®å®šå®ƒæ²¡æœ‰åœ¨NATåé¢ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœå¤§å¤šæ•°æ‹¨å·å°è¯•å¤±è´¥ï¼Œåˆ™å¼ºçƒˆè¡¨æ˜NATæ­£åœ¨é˜»æ­¢ä¼ å…¥è¿æ¥

> ç›®å‰ï¼ŒAutoNATä¸èƒ½æµ‹è¯•å•ä¸ªåœ°å€ï¼Œä½†æ˜¯AutoNAT v2çš„æè®®æ—¨åœ¨æ·»åŠ æ­¤åŠŸèƒ½ã€‚

AutoNATåè®®ä½¿ç”¨åè®®ID `/libp2p/ AutoNAT /1.0.0`ï¼ŒåŒ…æ‹¬`Dial`å’Œ`DialResponse`æ¶ˆæ¯çš„äº¤æ¢ã€‚

ä¸ºäº†å¯åŠ¨è¯¥åè®®ï¼Œä¸€ä¸ªèŠ‚ç‚¹å‘å¦ä¸€ä¸ªå¯¹ç­‰èŠ‚ç‚¹å‘é€ä¸€ä¸ªåŒ…å«å¤šåœ°å€åˆ—è¡¨çš„`Dial`æ¶ˆæ¯ã€‚ç„¶åï¼Œå¯¹ç­‰èŠ‚ç‚¹å°è¯•ä½¿ç”¨ä¸å¸¸è§„libp2pè¿æ¥ä¸åŒçš„IPå’Œå¯¹ç­‰ä½“IDæ¥æ‹¨å·è¿™äº›åœ°å€ã€‚å¦‚æœè‡³å°‘æœ‰ä¸€æ¬¡æ‹¨å·æˆåŠŸï¼Œå¯¹ç­‰ä½“å°†å‘è¯·æ±‚èŠ‚ç‚¹å‘é€ä¸€ä¸ªå¸¦æœ‰`ResponseStatus: SUCCESS`çš„`DialResponse`æ¶ˆæ¯ã€‚

å¦‚æœæ‰€æœ‰æ‹¨å·éƒ½å¤±è´¥ï¼Œå¯¹ç­‰ä½“å°†å‘é€ä¸€ä¸ª`DialResponse`æ¶ˆæ¯`ResponseStatus: E_DIAL_ERROR`ã€‚è¯·æ±‚èŠ‚ç‚¹å¯ä»¥ä½¿ç”¨æ¥è‡ªå¯¹ç­‰ç«¯çš„å“åº”æ¥ç¡®å®šå®ƒæ˜¯å¦åœ¨NATåé¢ã€‚

> å¦‚æœå“åº”è¡¨æ˜æˆåŠŸï¼Œåˆ™è¯¥èŠ‚ç‚¹å¯èƒ½ä¸åœ¨NATåé¢ï¼Œå¹¶ä¸”ä¸éœ€è¦ä½¿ç”¨ä¸­ç»§æœåŠ¡å™¨æ¥æ”¹å–„å…¶è¿é€šæ€§ã€‚å¦‚æœå“åº”æŒ‡ç¤ºé”™è¯¯ï¼Œåˆ™è¯¥èŠ‚ç‚¹å¯èƒ½åœ¨NATä¹‹åï¼Œå¯èƒ½éœ€è¦ä½¿ç”¨ä¸­ç»§æœåŠ¡å™¨ä¸ç½‘ç»œä¸­çš„å…¶ä»–èŠ‚ç‚¹è¿›è¡Œé€šä¿¡ã€‚

ä¸ºäº†é˜²æ­¢æŸäº›ç±»å‹çš„æ”»å‡»ï¼Œlibp2pçš„AutoNATå®ç°ä¸èƒ½æ‹¨å·ä»»ä½•ä¸åŸºäºè¯·æ±‚èŠ‚ç‚¹çš„IPåœ°å€çš„å¤šåœ°å€ï¼Œä¹Ÿä¸èƒ½é€šè¿‡ä¸­ç»§è¿æ¥æ¥å—æ‹¨å·è¯·æ±‚ï¼ˆå› ä¸ºæ— æ³•éªŒè¯é€šè¿‡ä¸­ç»§è¿æ¥åˆ°è¾¾çš„èŠ‚ç‚¹çš„IPåœ°å€ï¼‰ã€‚

è¿™æ˜¯ä¸ºäº†é˜²æ­¢æ”¾å¤§æ”»å‡»ï¼Œåœ¨æ”¾å¤§æ”»å‡»ä¸­ï¼Œæ”»å‡»è€…å‘è®¸å¤šå®¢æˆ·ç«¯æä¾›æŒ‡å‘é¢„å®šç›®æ ‡çš„ç›¸åŒä¼ªé€ çš„[MAPPED-ADDRESS](https://www.rfc-editor.org/rfc/rfc3489#section-11.2.1)ï¼Œå¯¼è‡´æ‰€æœ‰æµé‡éƒ½é›†ä¸­åœ¨ç›®æ ‡ä¸Šã€‚

> ğŸ’¡See the AutoNAT [technical specification](https://github.com/libp2p/specs/blob/master/autonat/README.md) for more details.

# çº¿è·¯ä¸­ç»§ï¼ˆCicuit Relayï¼‰

## What is Circuit Relay?

Circuit Relay æ˜¯ä¸€ç§ä¼ è¾“åè®®ï¼Œé€šè¿‡ç¬¬ä¸‰æ–¹ "ä¸­ç»§" èŠ‚ç‚¹æ¥è½¬å‘ä¸¤ä¸ªèŠ‚ç‚¹ä¹‹é—´çš„æµé‡ã€‚

åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼ŒèŠ‚ç‚¹æ— æ³•ç©¿é€å…¶ NATï¼ˆç½‘ç»œåœ°å€è½¬æ¢ï¼‰æˆ–é˜²ç«å¢™ï¼Œæ— æ³•ä½¿å…¶å…¬å¼€å¯è®¿é—®ã€‚æˆ–è€…ï¼Œå®ƒä»¬å¯èƒ½ä¸å…±äº«å¯ä»¥ç›´æ¥é€šä¿¡çš„å…¬å…±ä¼ è¾“åè®®ã€‚

ä¸ºäº†è§£å†³ç±»ä¼¼ NAT ç­‰è¿æ¥éšœç¢ï¼Œlibp2p å®šä¹‰äº†ä¸€ç§åä¸º [**p2p-circuit** ](https://github.com/libp2p/specs/tree/master/relay)çš„åè®®ã€‚å½“æŸä¸ªèŠ‚ç‚¹æ— æ³•ç›‘å¬å…¬å…±åœ°å€æ—¶ï¼Œå®ƒå¯ä»¥å‘ä¸­ç»§èŠ‚ç‚¹å‘èµ·è¿æ¥ï¼Œä¸­ç»§èŠ‚ç‚¹å°†ä¿æŒä¸€ä¸ªé•¿æœŸè¿æ¥ã€‚å…¶ä»–èŠ‚ç‚¹å¯ä»¥é€šè¿‡ **p2p-circuit** åœ°å€æ‹¨å·è¿æ¥åˆ°ä¸­ç»§èŠ‚ç‚¹ï¼Œåè€…ä¼šå°†æµé‡è½¬å‘åˆ°ç›®æ ‡èŠ‚ç‚¹ã€‚

Cicuit Relayåè®®çš„çµæ„Ÿæ¥æºäº [TURN](https://tools.ietf.org/html/rfc5766)ï¼ˆTraversal Using Relays around NATï¼‰ï¼Œå®ƒæ˜¯ NAT ç©¿é€æŠ€æœ¯çš„[äº¤äº’å¼è¿æ¥å»ºç«‹](https://tools.ietf.org/html/rfc8445)çš„ä¸€éƒ¨åˆ†ã€‚

> ä¸­ç»§è¿æ¥æ˜¯ç«¯åˆ°ç«¯åŠ å¯†çš„ï¼Œè¿™æ„å‘³ç€å……å½“ä¸­ç»§çš„å¯¹ç­‰ä½“æ— æ³•è¯»å–æˆ–ç¯¡æ”¹æµç»è¯¥è¿æ¥çš„ä»»ä½•é€šä¿¡ã€‚

ä¸­ç»§åè®®çš„ä¸€ä¸ªé‡è¦ç‰¹æ€§æ˜¯å®ƒå¹¶éâ€œé€æ˜â€çš„ã€‚æ¢å¥è¯è¯´ï¼ŒæºèŠ‚ç‚¹å’Œç›®æ ‡èŠ‚ç‚¹éƒ½çŸ¥é“å®ƒä»¬çš„æµé‡æ­£åœ¨è¢«ä¸­ç»§è½¬å‘ã€‚è¿™ç§è®¾è®¡éå¸¸æœ‰ç”¨ï¼Œå› ä¸ºç›®æ ‡èŠ‚ç‚¹èƒ½å¤Ÿçœ‹åˆ°ç”¨äºå»ºç«‹è¿æ¥çš„ä¸­ç»§åœ°å€ï¼Œå¹¶å¯èƒ½ä½¿ç”¨è¯¥åœ°å€æ„å»ºè¿”å›æºèŠ‚ç‚¹çš„è·¯å¾„ã€‚æ­¤å¤–ï¼Œè¿™ç§é€šä¿¡ä¹Ÿä¸æ˜¯åŒ¿åçš„â€”â€”æ‰€æœ‰å‚ä¸è€…ï¼ŒåŒ…æ‹¬ä¸­ç»§èŠ‚ç‚¹ï¼Œéƒ½é€šè¿‡å…¶ **Peer ID** è¿›è¡Œæ ‡è¯†ã€‚

è¿™ç§éé€æ˜æ€§å¯ä»¥å¸®åŠ©å®ç°è¿æ¥çš„å¯è¿½æº¯æ€§ï¼Œç¡®ä¿æ‰€æœ‰é€šä¿¡æ–¹å¯ä»¥è¯†åˆ«å½¼æ­¤çš„èº«ä»½ï¼Œå¢å¼ºäº†ç½‘ç»œçš„å®‰å…¨æ€§å’Œæ§åˆ¶åŠ›ï¼Œå°¤å…¶æ˜¯åœ¨éœ€è¦è¿›è¡Œåç»­åŒå‘é€šä¿¡æ—¶ã€‚

## åè®®ç‰ˆæœ¬

ç›®å‰æœ‰ä¸¤ä¸ªç‰ˆæœ¬çš„ä¸­ç»§åè®®ï¼Œ[v1](https://github.com/libp2p/specs/blob/master/relay/circuit-v1.md)å’Œ[v2](https://github.com/libp2p/specs/blob/master/relay/circuit-v2.md)ã€‚æˆ‘ä»¬å»ºè®®ä½¿ç”¨åè€…è€Œä¸æ˜¯å‰è€…ã€‚æœ‰å…³ä¸¤è€…çš„è¯¦ç»†æ¯”è¾ƒï¼Œè¯·å‚é˜…[circuit relay v2 specification](https://github.com/libp2p/specs/blob/master/relay/circuit-v2.md#introduction)ã€‚å¦‚æœæ²¡æœ‰æ˜ç¡®è¯´æ˜ï¼Œæœ¬æ–‡æ¡£æè¿°äº†çº¿è·¯ä¸­ç»§v2åè®®ã€‚

## ä¸­ç»§åœ°å€

ä¸­ç»§ç”µè·¯ï¼ˆRelay Circuitï¼‰åœ¨ libp2p ä¸­ä½¿ç”¨ä¸€ç§ [multiaddr](https://docs.libp2p.io/concepts/appendix/glossary/#multiaddr)è¿›è¡Œæ ‡è¯†ï¼ŒåŒ…å«è¦ä¸­ç»§æµé‡çš„èŠ‚ç‚¹çš„[Peer ID](https://docs.libp2p.io/concepts/fundamentals/peers/#peer-id)ï¼ˆå³ç›‘å¬èŠ‚ç‚¹æˆ–â€œä¸­ç»§ç›®æ ‡â€ï¼‰ã€‚
ä¾‹å¦‚ï¼Œå¦‚æœæˆ‘æœ‰ä¸€ä¸ª libp2p èŠ‚ç‚¹ï¼ŒPeer ID æ˜¯ **QmAlice**ï¼Œè€Œä¸”æˆ‘åœ¨ NAT åé¢ï¼Œå…¶ä»–äººæ— æ³•ç›´æ¥æ‹¨å·è®¿é—®æˆ‘ã€‚ä¸ºäº†è®©æˆ‘çš„æœ‹å‹ **QmBob** å¯ä»¥è¿æ¥åˆ°æˆ‘ï¼Œæˆ‘å¯ä»¥ä½¿ç”¨ä¸­ç»§èŠ‚ç‚¹çš„å¸®åŠ©ã€‚

æœ€åŸºæœ¬çš„ **p2p-circuit** åœ°å€å¦‚ä¸‹æ‰€ç¤ºï¼š

```
/p2p-circuit/p2p/QmAlice
```

è¯¥åœ°å€æ²¡æœ‰åŒ…å«å…·ä½“çš„ä¼ è¾“åœ°å€ï¼Œè¿™æ„å‘³ç€å…¶ä»–èŠ‚ç‚¹åªèƒ½é€šè¿‡å‘ç°ä¸€ä¸ªåˆé€‚çš„ä¸­ç»§èŠ‚ç‚¹ï¼Œå¹¶æœŸæœ›ä¸­ç»§èŠ‚ç‚¹å·²ç»å’Œæˆ‘æœ‰è¿æ¥ã€‚ç„¶è€Œï¼Œæ›´å¥½çš„æ–¹æ³•æ˜¯æ˜ç¡®æŒ‡å®šä¸­ç»§èŠ‚ç‚¹çš„åœ°å€ï¼Œä¾‹å¦‚ï¼š

```
/p2p/QmRelay/p2p-circuit/p2p/QmAlice
```

è¿™ä¸ªåœ°å€åŒ…æ‹¬äº†ä¸­ç»§èŠ‚ç‚¹çš„èº«ä»½ï¼ˆPeer IDï¼š**QmRelay**ï¼‰ã€‚å¦‚æœå…¶ä»–èŠ‚ç‚¹çŸ¥é“å¦‚ä½•ä¸ **QmRelay** å»ºç«‹è¿æ¥ï¼Œä»–ä»¬å°±å¯ä»¥é€šè¿‡ä¸­ç»§èŠ‚ç‚¹åˆ°è¾¾æˆ‘ã€‚

æ›´å®Œæ•´çš„åœ°å€è¿˜åŒ…æ‹¬ä¸­ç»§èŠ‚ç‚¹çš„ä¼ è¾“åœ°å€ä¿¡æ¯ã€‚å‡è®¾ä¸­ç»§èŠ‚ç‚¹ **QmRelay** ç›‘å¬ **198.51.100.0** ä¸Šçš„ TCP ç«¯å£ **55555**ï¼Œå¯ä»¥æ„å»ºå¦‚ä¸‹è·¯å¾„ï¼š

```
/ip4/198.51.100.0/tcp/55555/p2p/QmRelay/p2p-circuit/p2p/QmAlice
```

åœ¨è¿™ä¸ªåœ°å€ä¸­ï¼Œ**/p2p-circuit/** ä¹‹å‰çš„éƒ¨åˆ†æ˜¯ä¸­ç»§èŠ‚ç‚¹çš„åœ°å€ä¿¡æ¯ï¼ŒåŒ…å«ä¼ è¾“åœ°å€å’Œ Peer IDã€‚**/p2p-circuit/** ä¹‹åçš„éƒ¨åˆ†æ˜¯ç›®æ ‡èŠ‚ç‚¹çš„ Peer ID **QmAlice**ã€‚é€šè¿‡å°†è¿™ä¸ªå®Œæ•´çš„ä¸­ç»§è·¯å¾„åœ°å€æä¾›ç»™ **QmBob**ï¼Œä»–å¯ä»¥å¿«é€Ÿå»ºç«‹è¿æ¥ï¼Œè€Œä¸éœ€è¦å†â€œè¯¢é—®â€æ˜¯å¦æœ‰å¯ç”¨çš„ä¸­ç»§èŠ‚ç‚¹èƒ½è¿æ¥åˆ° **QmAlice**ã€‚

è¿™ä¸€æœºåˆ¶æœ‰æ•ˆè§£å†³äº†NATç©¿é€é—®é¢˜ï¼Œä½¿å¾—åœ¨å»ä¸­å¿ƒåŒ–çš„ P2P ç½‘ç»œä¸­ï¼ŒèŠ‚ç‚¹å¯ä»¥é€šè¿‡ä¸­ç»§å®ç°è¿æ¥ã€‚

> å½“å‘å¸ƒæ‚¨çš„åœ°å€æ—¶ï¼Œæœ€å¥½æä¾›ä¸­ç»§åœ°å€ï¼Œå…¶ä¸­åŒ…æ‹¬ä¸­ç»§å¯¹ç­‰ä½“çš„ä¼ è¾“åœ°å€ã€‚
> å¦‚æœä¸­ç»§æœ‰è®¸å¤šä¼ è¾“åœ°å€ï¼Œæ‚¨å¯ä»¥é€šè¿‡å®ƒä»¬ä¸­çš„ä»»ä½•ä¸€ä¸ªå‘å¸ƒä¸€ä¸ª`p2p-circuit`ã€‚

## è¿‡ç¨‹

ä¸‹é¢çš„é¡ºåºå›¾æè¿°äº†ä¸€ä¸ªç¤ºä¾‹ä¸­ç»§è¿‡ç¨‹ï¼š

![circuit-v2.svg](../assets/img/nat-traversal/circuit-v2.svg)

åœ¨è¿™ä¸ªåœºæ™¯ä¸­ï¼ŒNode A ä½äº NAT æˆ–é˜²ç«å¢™åï¼Œæ— æ³•é€šè¿‡ç›´æ¥çš„å…¬ç½‘åœ°å€è¿›è¡Œé€šä¿¡ã€‚é€šè¿‡ **AutoNAT** æœåŠ¡ï¼ŒNode A æ£€æµ‹åˆ°è‡ªå·±æ— æ³•å¯¹å¤–å…¬å¼€åœ°å€ï¼Œå› æ­¤è¯·æ±‚ä¸­ç»§èŠ‚ç‚¹ **R** è¿›è¡Œ**é¢„ç•™**ï¼ˆReservationï¼‰ï¼Œå³è¯·æ±‚ **R** ä»£è¡¨è‡ªå·±ç›‘å¬ä¼ å…¥çš„è¿æ¥ã€‚

æµç¨‹å¦‚ä¸‹ï¼š

1. èŠ‚ç‚¹Aä½äºNATå’Œ/æˆ–é˜²ç«å¢™åé¢ï¼Œä¾‹å¦‚é€šè¿‡ [AutoNAT service](https://docs.libp2p.io/concepts/nat/autonat/)æ£€æµ‹åˆ°ã€‚
2. **Node A è¯·æ±‚é¢„ç•™**ï¼šNode A å‘ä¸­ç»§èŠ‚ç‚¹ **R** å‘å‡ºè¯·æ±‚ï¼Œè¦æ±‚å®ƒä¸ºè‡ªå·±é¢„ç•™åœ°å€å¹¶ä»£ä¸ºç›‘å¬å¤–éƒ¨çš„è¿æ¥è¯·æ±‚ã€‚é€šè¿‡è¿™ç§æ–¹å¼ï¼Œå…¶ä»–èŠ‚ç‚¹å¯ä»¥é€šè¿‡ **R** è¿æ¥åˆ° **A**ã€‚
3. **Node B è¯·æ±‚ä¸ Node A å»ºç«‹è¿æ¥**ï¼šç”±äº **A** æ²¡æœ‰å…¬å¼€ç›´æ¥å¯è¾¾çš„åœ°å€ï¼ŒNode B åªèƒ½é€šè¿‡ **A** æä¾›çš„ä¸­ç»§åœ°å€æ¥å‘èµ·è¿æ¥ã€‚Node B å‘ä¸­ç»§èŠ‚ç‚¹ **R** å‘é€è¿æ¥è¯·æ±‚ï¼Œè¦æ±‚ä¸­ç»§ **R** è½¬å‘è¿æ¥åˆ° **A**ã€‚
4. **ä¸­ç»§èŠ‚ç‚¹ R å¤„ç†è¿æ¥**ï¼šä¸­ç»§ **R** æ¥æ”¶åˆ° **B** çš„è¯·æ±‚åï¼Œä¼šå°†è¯¥è¯·æ±‚è½¬å‘ç»™ **A**ã€‚ä¹‹åï¼Œ**R** å……å½“æ•°æ®è½¬å‘å™¨ï¼Œè´Ÿè´£å°† **A** å’Œ **B** ä¹‹é—´çš„æ‰€æœ‰æ•°æ®è¿›è¡Œä¸­ç»§è½¬å‘ã€‚

æ•´ä¸ªè¿‡ç¨‹æ˜¯é€šè¿‡ libp2p çš„ **p2p-circuit** åè®®å®ç°çš„ï¼Œå®ƒèƒ½å¤Ÿå¸®åŠ© NAT åçš„èŠ‚ç‚¹é€šè¿‡ä¸­ç»§èŠ‚ç‚¹è¿›è¡Œé€šä¿¡ï¼Œä»è€Œè§£å†³ NAT ç©¿é€é—®é¢˜ï¼Œä¿éšœ P2P ç½‘ç»œçš„è¿é€šæ€§ã€‚

# DCUtR
## èƒŒæ™¯
ä½¿ç”¨ä¸­ç»§ä½œä¸ºä»£ç†æ¥éå†natï¼Œä½†æ˜¯è¿™åœ¨æ‰©å±•å’Œç»´æŠ¤æ–¹é¢çš„æˆæœ¬å¯èƒ½å¾ˆé«˜ï¼Œå¹¶ä¸”å¯èƒ½å¯¼è‡´ä½å¸¦å®½ã€é«˜å»¶è¿Ÿçš„è¿æ¥ã€‚[Hole punching](https://docs.libp2p.io/concepts/nat/hole-punching/)ï¼ˆæ‰“æ´ï¼‰æ˜¯å¦ä¸€ç§é€šè¿‡ä½¿NATåé¢çš„ä¸¤ä¸ªèŠ‚ç‚¹ç›´æ¥é€šä¿¡æ¥å®ç°NATç©¿é€çš„æŠ€æœ¯ã€‚ç„¶è€Œï¼Œé™¤äº†ä¸­ç»§èŠ‚ç‚¹ä¹‹å¤–ï¼Œå®ƒè¿˜éœ€è¦å¦ä¸€ä¸ªç§°ä¸ºä¿¡ä»¤æœåŠ¡å™¨ï¼ˆ[signaling server](https://docs.libp2p.io/concepts/nat/appendix/glossary.md#signaling-server)ï¼‰çš„åŸºç¡€è®¾æ–½ã€‚

å¥½æ¶ˆæ¯æ˜¯libp2pæä¾›äº†ä¸€ä¸ªæ‰“æ´è§£å†³æ–¹æ¡ˆï¼Œå®ƒæ¶ˆé™¤äº†å¯¹é›†ä¸­å¼ä¿¡ä»¤æœåŠ¡å™¨çš„éœ€æ±‚ï¼Œå¹¶å…è®¸ä½¿ç”¨åˆ†å¸ƒå¼ä¸­ç»§èŠ‚ç‚¹ã€‚

## ä»€ä¹ˆæ˜¯é€šè¿‡ä¸­ç»§ç›´æ¥è¿æ¥å‡çº§ï¼Ÿ

libp2p DCUtR ï¼ˆDirect Connection Upgrade through Relayï¼‰æ˜¯ä¸€ç§é€šè¿‡æ‰“æ´åœ¨èŠ‚ç‚¹ä¹‹é—´å»ºç«‹ç›´æ¥è¿æ¥çš„åè®®ï¼Œä¸éœ€è¦ä¿¡ä»¤æœåŠ¡å™¨ã€‚DCUtRåŒ…æ‹¬åŒæ­¥å’Œæ‰“å¼€åˆ°æ¯ä¸ªå¯¹ç­‰ç«¯é¢„æµ‹çš„å¤–éƒ¨åœ°å€çš„è¿æ¥ã€‚

DCUtRåè®®ä½¿ç”¨åè®®ID /libp2p/ DCUtRï¼ŒåŒ…æ‹¬Connectå’ŒSyncæ¶ˆæ¯çš„äº¤æ¢ã€‚

DCUtRåè®®æ”¯æŒTCPã€QUICç­‰ä¸åŒç±»å‹çš„è¿æ¥ï¼Œä¸åŒç±»å‹çš„è¿æ¥å»ºç«‹è¿‡ç¨‹ä¸åŒã€‚

@Dennis-traæœ‰ä¸€ä¸ªå…³äºdcurå’Œå®ƒçš„æ‰“æ´æˆåŠŸç‡çš„[great talk](https://www.youtube.com/watch?v=fyhZWlDbcyM)ã€‚

äº†è§£NATéå†å¦‚ä½•å·¥ä½œçš„æœ‰ç”¨èµ„æºæ˜¯Tailscaleçš„[this blog post](https://tailscale.com/blog/how-nat-traversal-works/)ã€‚

> ğŸ’¡è¯¦ç»†ä¿¡æ¯è¯·å‚è§DCUtRæŠ€æœ¯è§„èŒƒï¼ˆ[technical specification](https://github.com/libp2p/specs/blob/master/relay/DCUtR.md)ï¼‰ã€‚

# Hole Punching

ç‚¹å¯¹ç‚¹ç½‘ç»œä¸Šçš„èŠ‚ç‚¹å¯ä»¥åˆ†ä¸ºå…¬å…±å’Œéå…¬å…±ä¸¤ç±»ã€‚å…¬å…±èŠ‚ç‚¹æ˜¯é‚£äº›å¯ä»¥ä¸å—é˜»ç¢åœ°è®¿é—®äº’è”ç½‘çš„èŠ‚ç‚¹ï¼Œè€Œéå…¬å…±èŠ‚ç‚¹ä½äºæŸç§é˜²ç«å¢™åé¢ã€‚è¿™é€‚ç”¨äºå®¶åº­å’Œå…¬å¸ç½‘ç»œçš„å¤§å¤šæ•°èŠ‚ç‚¹ï¼Œä»¥åŠç§»åŠ¨ç”µè¯ã€‚åœ¨å¤§å¤šæ•°é…ç½®ä¸­ï¼Œå…¬å…±å’Œéå…¬å…±èŠ‚ç‚¹éƒ½å¯ä»¥æ‹¨å·è¿æ¥åˆ°å…¶ä»–å…¬å…±èŠ‚ç‚¹ã€‚ä½†æ˜¯ï¼Œä¸å¯èƒ½å»ºç«‹ä»å…¬å…±äº’è”ç½‘åˆ°éå…¬å…±èŠ‚ç‚¹çš„è¿æ¥ã€‚

## æ‹¨å·éå…¬å…±èŠ‚ç‚¹

è¿™é‡Œæœ‰ä¸€äº›èŠ‚ç‚¹å¯ä»¥ç”¨æ¥æ‹¨å·éå…¬å…±èŠ‚ç‚¹çš„æ–¹æ³•ï¼š

- UPnPï¼ˆé€šç”¨å³æ’å³ç”¨ï¼‰ï¼šè·¯ç”±å™¨å’Œç½‘ç»œå†…è®¡ç®—æœºä¹‹é—´ä½¿ç”¨çš„åè®®ã€‚å®ƒå…è®¸è®¡ç®—æœºè¯·æ±‚æŸäº›ç«¯å£è¢«æ‰“å¼€å¹¶è½¬å‘åˆ°è¯¥è®¡ç®—æœºã€‚
- ç«¯å£è½¬å‘ï¼šåœ¨è·¯ç”±å™¨ä¸Šæ‰‹åŠ¨é…ç½®ç«¯å£è½¬å‘ã€‚
## é™åˆ¶

åœ¨è®¸å¤šæƒ…å†µä¸‹ï¼ŒUPnPè¢«è·¯ç”±å™¨æˆ–é˜²ç«å¢™ç¦ç”¨ã€‚UPnPä¹Ÿå¯èƒ½æ— æ³•å·¥ä½œï¼Œè¿™å–å†³äºè·¯ç”±å™¨çš„å›ºä»¶ã€‚

æ‰‹åŠ¨æ‰“å¼€ç«¯å£éœ€è¦ä¸“ä¸šæŠ€æœ¯ï¼Œå¹¶ä¸”ä¸å¼ºåˆ¶è¿›è¡Œèº«ä»½éªŒè¯æˆ–æˆæƒã€‚

## å¯èƒ½çš„è§£å†³æ–¹æ¡ˆï¼šhole punching

### ä¸­ç»§æ¦‚è§ˆ

ä¸­ç»§æ˜¯ä¸€ç§ç”¨äºåœ¨ä¸¤ç«¯ä¹‹é—´å‘é€ä¿¡æ¯çš„æœºåˆ¶ã€‚å¯¹äºéå…¬æœ‰èŠ‚ç‚¹ï¼š

èŠ‚ç‚¹Aä¸ä¸­ç»§èŠ‚ç‚¹Rä¿æŒæ°¸ä¹…è¿æ¥ï¼Œå½“èŠ‚ç‚¹Bæƒ³è¦è¿æ¥åˆ°èŠ‚ç‚¹Aæ—¶ï¼Œå®ƒé¦–å…ˆä¸èŠ‚ç‚¹Rå»ºç«‹è¿æ¥ï¼ŒèŠ‚ç‚¹Rè½¬å‘è¯¥è¿æ¥ä¸Šçš„æ‰€æœ‰æ•°æ®åŒ…ã€‚ä¸­ç»§å¢åŠ äº†é¢å¤–çš„å»¶è¿Ÿï¼Œå¹¶ä¸”æ˜¯èµ„æºå¯†é›†å‹çš„ï¼Œå› ä¸ºèŠ‚ç‚¹Réœ€è¦å¤„ç†å¤§é‡çš„æµé‡ã€‚ä½¿ç”¨ä¸­ç»§èŠ‚ç‚¹è¿˜éœ€è¦æŠ€æœ¯ä¸“ä¸šçŸ¥è¯†ã€‚

### å¦‚æœæˆ‘ä»¬å¯ä»¥ä½¿ç”¨èŠ‚ç‚¹Ræ¥å¸®åŠ©ä¿ƒè¿›èŠ‚ç‚¹Aå’ŒèŠ‚ç‚¹Bä¹‹é—´çš„ç›´æ¥è¿æ¥å‘¢ï¼Ÿ

åœ¨å…¶ä»–é€‰æ‹©éƒ½ä¸å¤Ÿçš„æƒ…å†µä¸‹ï¼Œç½‘ç»œå¯ä»¥ä½¿ç”¨ä¸€ç§ç§°ä¸ºæ‰“æ´çš„æŠ€æœ¯æ¥ä¸éå…¬å…±èŠ‚ç‚¹å»ºç«‹è¿æ¥ã€‚

æ¯ä¸ªèŠ‚ç‚¹è¿æ¥åˆ°ä¸­ç»§èŠ‚ç‚¹å¹¶å…±äº«å…¶å¤–éƒ¨åœ°å€å’Œç«¯å£ä¿¡æ¯ã€‚æœåŠ¡å™¨ä¸´æ—¶å­˜å‚¨èŠ‚ç‚¹çš„ä¿¡æ¯ï¼Œå¹¶å°†æ¯ä¸ªèŠ‚ç‚¹çš„ä¿¡æ¯è½¬å‘ç»™å…¶ä»–èŠ‚ç‚¹ã€‚å®¢æˆ·ç«¯å¯ä»¥ä½¿ç”¨è¿™äº›ä¿¡æ¯å»ºç«‹å½¼æ­¤ä¹‹é—´çš„ç›´æ¥è¿æ¥ã€‚

ä»¥ä¸¤ä¸ªèŠ‚ç‚¹Aå’ŒBä¸ºä¾‹ï¼Œå®ƒä»¬æƒ³è¦ç›¸äº’æ‹¨å·ï¼š
1. ä¸¤ä¸ªèŠ‚ç‚¹çš„ç¬¬ä¸€ä¸ªæ•°æ®åŒ…ï¼ˆä¾‹å¦‚ï¼Œåœ¨TCPçš„æƒ…å†µä¸‹ï¼Œä¸€ä¸ªSYNï¼‰é€šè¿‡å®ƒä»¬å„è‡ªçš„è·¯ç”±å™¨ã€‚
1. è·¯ç”±å™¨å°†ä¸€ä¸ª5å…ƒç»„æ·»åŠ åˆ°è·¯ç”±å™¨çš„çŠ¶æ€è¡¨ä¸­ã€‚

   > ğŸ’¡è·¯ç”±å™¨çŠ¶æ€è¡¨ï¼ˆè·¯ç”±è¡¨ï¼‰æ˜¯å­˜å‚¨åœ¨è·¯ç”±å™¨ä¸­çš„æ•°æ®ï¼Œå®ƒåˆ—å‡ºäº†åˆ°ç‰¹å®šç½‘ç»œç›®çš„åœ°çš„è·¯ç”±ã€‚5å…ƒç»„ç»“æ„åŒ…æ‹¬æºIPåœ°å€ã€æºç«¯å£ã€ç›®çš„IPåœ°å€ã€ç›®çš„ç«¯å£å’Œä¼ è¾“åè®®ã€‚

1. PacketAå’ŒPacketBåœ¨å„è‡ªè·¯ç”±å™¨çš„é˜²ç«å¢™ä¸Šâ€œæ‰“æ´â€ã€‚
1. ä¸¤ä¸ªåŒ…åˆ°è¾¾å¯¹æ–¹çš„è·¯ç”±å™¨ã€‚
1. å½“Açš„æ•°æ®åŒ…åˆ°è¾¾Router_Bæ—¶ï¼ŒRouter_Bæ£€æŸ¥è‡ªå·±çš„çŠ¶æ€è¡¨ï¼Œå‘ç°ä¸€ä¸ª5å…ƒç»„æ˜¯åœ¨èŠ‚ç‚¹Bå‘é€çš„æ•°æ®åŒ…ä¸­æ·»åŠ çš„ã€‚
1. è·¯ç”±å™¨é€šè¿‡â€œæ‰“æ´â€å°†æ•°æ®åŒ…è½¬å‘ç»™Bã€‚Bçš„æ•°æ®åŒ…ä¹Ÿæ˜¯å¦‚æ­¤ï¼›åˆ°è¾¾Router_Aåï¼Œåœ¨Router_Açš„çŠ¶æ€è¡¨ä¸­åŒ¹é…ä¸€ä¸ª5å…ƒç»„ï¼Œå°†æŠ¥æ–‡è½¬å‘ç»™Aã€‚

ä¸‹é¢çš„ç”¨ä¾‹å›¾è¯´æ˜äº†ä¸Šé¢çš„è¿‡ç¨‹ã€‚ï¼ˆå›¾ç‰‡æ˜¾ç¤ºä¼¼ä¹æœ‰äº›é—®é¢˜ï¼Œè¯·ç‚¹å‡»å³é”®-åœ¨æ–°æ ‡ç­¾é¡µä¸­æ‰“å¼€é“¾æ¥ï¼‰
![libp2p-hole-punching-2.svg](../assets/img/nat-traversal/libp2p-hole-punching-2.svg)
> è¿™ä¸ªè¿‡ç¨‹å‡å®šäº†ä¸€ç§åŒæ—¶åŒæ­¥Aå’ŒBçš„æœºåˆ¶ã€‚

### Hole punching in libp2p

å—[ICEåè®®](https://datatracker.ietf.org/doc/html/rfc8445)çš„å¯å‘ï¼Œlibp2påŒ…æ‹¬ä¸€ä¸ªåˆ†æ•£çš„ç©¿å­”åŠŸèƒ½ï¼Œå…è®¸é˜²ç«å¢™å’ŒNATç©¿è¶Šï¼Œè€Œä¸éœ€è¦åƒSTUNå’ŒTURNè¿™æ ·çš„ä¸­å¤®åè°ƒæœåŠ¡å™¨ã€‚

ä¸‹é¢çš„é¡ºåºå›¾è¯´æ˜äº†æ•´ä¸ªè¿‡ç¨‹ã€‚

![p-4.svg](../assets/img/nat-traversal/p-4.svg)

Libp2pæ‰“æ´å¯åˆ†ä¸ºä¸¤ä¸ªé˜¶æ®µï¼Œå‡†å¤‡é˜¶æ®µå’Œæ‰“æ´é˜¶æ®µã€‚

#### ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡

1. [AutoNAT](https://docs.libp2p.io/concepts/nat/autonat/)ï¼šç¡®å®šèŠ‚ç‚¹æ˜¯å¦å¯æ‹¨å·ï¼Œä¾‹å¦‚ï¼Œå‘ç°èŠ‚ç‚¹æ˜¯å¦åœ¨NATæˆ–é˜²ç«å¢™åé¢ã€‚

2. AutoRelayï¼šåŠ¨æ€å‘ç°å’Œç»‘å®šç½‘ç»œä¸­çš„ä¸­ç»§èŠ‚ç‚¹ã€‚

> IPFSé€šè¿‡Kademlia DHTä½¿ç”¨æŸ¥æ‰¾æ–¹æ³•å‘ç°k-æœ€è¿‘çš„å…¬å…±ä¸­ç»§èŠ‚ç‚¹ï¼š/<RELAY_ADDR>/p2p-circuit/<PEER_ID_B>

![img](https://docs.libp2p.io/concepts/assets/hole-punching/libp2p-hole-punching-6.svg)

Bç½‘ç»œå¤–çš„Other_Peerså¯ä»¥é€šè¿‡å…¬å…±ä¸­ç»§èŠ‚ç‚¹é—´æ¥å‘¼å«Bã€‚åœ¨[IPFS](https://ipfs.tech/)çš„æƒ…å†µä¸‹ï¼Œæ¯ä¸ªå…¬å…±èŠ‚ç‚¹å°†å……å½“ä¸€ä¸ªä¸­ç»§ã€‚Bå°†åœ¨[Kademlia DHT](https://github.com/libp2p/specs/blob/master/kad-dht/README.md)ä¸ŠæŸ¥æ‰¾ä¸å…¶Peer IDæœ€è¿‘çš„å¯¹ç­‰èŠ‚ç‚¹ï¼Œæˆ–è€…é€‰æ‹©å·²ç»è¿æ¥åˆ°çš„å…¬å…±èŠ‚ç‚¹çš„ä¸€ä¸ªå­é›†ã€‚

3. [Circuit Relay](https://docs.libp2p.io/concepts/nat/circuit-relay/)ï¼šè¿æ¥åˆ°å‘ç°çš„ä¸­ç»§èŠ‚ç‚¹å¹¶è¯·æ±‚ä¿ç•™ã€‚èŠ‚ç‚¹å¯ä»¥é€šè¿‡è¿œç¨‹ä¸­ç»§èŠ‚ç‚¹å®£å¸ƒè‡ªå·±å¯è¾¾ã€‚

> è¿™ç›¸å½“äºICEä¸­çš„TURNåè®®ã€‚

![img](https://docs.libp2p.io/concepts/assets/hole-punching/libp2p-hole-punching-7.svg/)

- Relayå¯ä»¥é€šè¿‡Circuit Relay v2é™åˆ¶ç”¨äºä¸­ç»§è¿æ¥çš„èµ„æºï¼ˆä¾‹å¦‚ï¼Œé€šè¿‡è¿æ¥æ•°ã€æ—¶é—´å’Œå­—èŠ‚ï¼‰ã€‚åœ¨IPFSçš„æƒ…å†µä¸‹ï¼Œè¿™å…è®¸ç½‘ç»œä¸­çš„æ¯ä¸ªå…¬å…±èŠ‚ç‚¹å……å½“ä¸­ç»§ï¼Œè€Œä¸ä¼šæ¶ˆè€—å¤§é‡èµ„æºã€‚
- å¯¹äºæ¯ä¸ªå‘ç°çš„ä¸­ç»§èŠ‚ç‚¹ï¼ŒBï¼š
  - è¿æ¥åˆ°è¿œç¨‹èŠ‚ç‚¹ï¼Œå¹¶è¯·æ±‚ä¸­ç»§èŠ‚ç‚¹ä»£è¡¨å®ƒä¾¦å¬è¿æ¥ï¼Œç§°ä¸ºé¢„ç•™ï¼›
  - å¦‚æœRelayæ¥å—é¢„è®¢è¯·æ±‚ï¼Œåˆ™Bå¯ä»¥å®£å¸ƒè‡ªå·±å¯é€šè¿‡Relayè®¿é—®ã€‚

#### ç¬¬äºŒé˜¶æ®µ: Hole punching

1. [Circuit Relay](https://docs.libp2p.io/concepts/nat/circuit-relay/)ï¼šé€šè¿‡å…¬å…±ä¸­ç»§èŠ‚ç‚¹å»ºç«‹å®‰å…¨çš„ä¸­ç»§è¿æ¥ã€‚èŠ‚ç‚¹Aä¸ä¸­ç»§èŠ‚ç‚¹å»ºç«‹ç›´è¿ã€‚ç„¶åèŠ‚ç‚¹Bé€šè¿‡ä¸­ç»§èŠ‚ç‚¹è¯·æ±‚åˆ°èŠ‚ç‚¹açš„ä¸­ç»§è¿æ¥ï¼Œåˆ›å»ºä¸€ä¸ªåŒå‘é€šé“ï¼Œå¹¶ä½¿ç”¨TLSæ¥ä¿æŠ¤è¯¥é€šé“ã€‚

![img](https://docs.libp2p.io/concepts/assets/hole-punching/libp2p-hole-punching-8.svg/)

- Aä½¿ç”¨Bçš„é€šå‘Šåœ°å€ä¸­åŒ…å«çš„ä¿¡æ¯é€šè¿‡ä¸­ç»§å»ºç«‹åˆ°Bçš„ä¸­ç»§è¿æ¥ã€‚
  - Aé¦–å…ˆå»ºç«‹åˆ°Relayçš„ç›´æ¥è¿æ¥ï¼Œç„¶åä»Relayè¯·æ±‚åˆ°Bçš„ä¸­ç»§è¿æ¥ã€‚
  - Relayå°†è¯·æ±‚è½¬å‘ç»™Bå¹¶æ¥å—ã€‚
  - Relayå°†æ¥æ”¶è½¬å‘ç»™Aã€‚
  - Aå’ŒBå¯ä»¥ä½¿ç”¨Relayä¸Šçš„åŒå‘ä¿¡é“è¿›è¡Œé€šä¿¡ã€‚
  - Aå’ŒBä½¿ç”¨TLSç­‰å®‰å…¨åè®®å‡çº§å·²ä¸­ç»§è¿æ¥ã€‚

2. [DCUtR](https://github.com/libp2p/specs/blob/master/relay/DCUtR.md)ï¼šä½¿ç”¨DCUtRä½œä¸ºåŒæ­¥æœºæ„æ¥åè°ƒæ‰“æ´ã€‚


   ![img](https://docs.libp2p.io/concepts/assets/hole-punching/libp2p-hole-punching-9.svg/)
-  Aé€šè¿‡Relayå‘Bå‘é€Connectæ¶ˆæ¯ã€‚

  - è¿æ¥åŒ…å«açš„åœ°å€ã€‚libp2pæä¾›äº†å¤šç§æœºåˆ¶æ¥å‘ç°ä¸€ä¸ªäººçš„åœ°å€ï¼Œä¾‹å¦‚ï¼Œé€šè¿‡libp2pè¯†åˆ«åè®®ã€‚

- Båœ¨ä¸­ç»§è¿æ¥ä¸Šæ¥æ”¶Connectæ¶ˆæ¯ï¼Œå¹¶å›å¤ä¸€ä¸ªåŒ…å«å…¶ï¼ˆéä¸­ç»§ï¼‰åœ°å€çš„Connectæ¶ˆæ¯ã€‚

  - Aæµ‹é‡å‘é€æ¶ˆæ¯å’Œæ¥æ”¶Bæ¶ˆæ¯ä¹‹é—´çš„æ—¶é—´ï¼Œä»è€Œç¡®å®šAå’ŒBä¹‹é—´é€šè¿‡Relayçš„å¾€è¿”æ—¶é—´ã€‚

- ç„¶åï¼ŒAåœ¨ä¸­ç»§è¿æ¥ä¸Šå‘Bå‘é€åŒæ­¥æ¶ˆæ¯ã€‚

- Aç­‰å¾…ä¸€åŠçš„å¾€è¿”æ—¶é—´ï¼Œç„¶åé€šè¿‡Bçš„Connectæ¥æ”¶åˆ°çš„åœ°å€ç›´æ¥æ‹¨æ‰“Bã€‚

- ä¸€æ—¦Bæ”¶åˆ°Açš„Syncæ¶ˆæ¯ï¼Œå®ƒå°±ç›´æ¥ä½¿ç”¨Açš„Connectæ¶ˆæ¯ä¸­æä¾›çš„åœ°å€æ‹¨æ‰“Aã€‚

- ä¸€æ—¦Aå’ŒBåŒæ—¶æ‹¨å·ï¼Œå°±ä¼šå‘ç”Ÿæ‰“æ´ã€‚

# Â [Resources](https://docs.libp2p.io/concepts/nat/hole-punching/#resources)

- This guide is a byproduct of theÂ [Hole punching in libp2p - Overcoming Firewalls](https://blog.ipfs.tech/2022-01-20-libp2p-hole-punching/)Â blog post by Max Inden.
- Research paper onÂ [decentralized hole punching by Protocol Labs Research](https://research.protocol.ai/publications/decentralized-hole-punching/)
- Keep up with theÂ [libp2p implementations page](https://libp2p.io/implementations/)Â for the state on different hole punching implementations.
